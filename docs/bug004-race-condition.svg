<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 820 920" font-family="'Segoe UI', Arial, sans-serif">
  <!-- Title -->
  <text x="410" y="35" text-anchor="middle" font-size="20" font-weight="bold" fill="#333">BUG-004: isLocalUpdateRef Race Condition</text>

  <!-- ============ BEFORE (top half) ============ -->
  <text x="410" y="70" text-anchor="middle" font-size="16" font-weight="bold" fill="#c0392b">BEFORE (boolean flag only) — feedback loop</text>

  <!-- Fabric box -->
  <rect x="40" y="90" width="160" height="44" rx="6" fill="#a8e6cf" stroke="#333" stroke-width="2"/>
  <text x="120" y="118" text-anchor="middle" font-size="15" font-weight="bold" fill="#333">Fabric.js</text>

  <!-- Yjs box -->
  <rect x="310" y="90" width="160" height="44" rx="6" fill="#ffd3b6" stroke="#333" stroke-width="2"/>
  <text x="390" y="118" text-anchor="middle" font-size="15" font-weight="bold" fill="#333">Yjs Y.Map</text>

  <!-- Observer box -->
  <rect x="590" y="90" width="180" height="44" rx="6" fill="#fdfd96" stroke="#333" stroke-width="2"/>
  <text x="680" y="118" text-anchor="middle" font-size="15" font-weight="bold" fill="#333">Yjs Observer</text>

  <!-- Lifelines -->
  <line x1="120" y1="134" x2="120" y2="440" stroke="#999" stroke-width="1.5" stroke-dasharray="6,4"/>
  <line x1="390" y1="134" x2="390" y2="440" stroke="#999" stroke-width="1.5" stroke-dasharray="6,4"/>
  <line x1="680" y1="134" x2="680" y2="440" stroke="#999" stroke-width="1.5" stroke-dasharray="6,4"/>

  <!-- Step 1: flag=true -->
  <rect x="20" y="150" width="200" height="24" rx="4" fill="#d5f5e3"/>
  <text x="120" y="167" text-anchor="middle" font-size="11" fill="#1a7a3a">isLocalUpdateRef = true</text>

  <!-- Step 2: Fabric -> Yjs write -->
  <line x1="120" y1="190" x2="380" y2="190" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="250" y="185" text-anchor="middle" font-size="12" fill="#333">updateObject(rect-abc)</text>

  <!-- Step 3: flag=false -->
  <rect x="20" y="205" width="200" height="24" rx="4" fill="#fadbd8"/>
  <text x="120" y="222" text-anchor="middle" font-size="11" fill="#c0392b">isLocalUpdateRef = false</text>

  <!-- Microtask boundary -->
  <line x1="10" y1="248" x2="790" y2="248" stroke="#e74c3c" stroke-width="1" stroke-dasharray="4,3"/>
  <text x="410" y="263" text-anchor="middle" font-size="11" font-style="italic" fill="#e74c3c">— microtask boundary (observer deferred) —</text>

  <!-- Step 4: Yjs -> Observer fires LATE -->
  <line x1="390" y1="283" x2="670" y2="283" stroke="#e67e22" stroke-width="2" marker-end="url(#arrow-orange)"/>
  <text x="530" y="278" text-anchor="middle" font-size="12" fill="#333">observer fires (LATE)</text>

  <!-- Step 5: Observer checks flag -->
  <rect x="590" y="296" width="180" height="24" rx="4" fill="#fadbd8"/>
  <text x="680" y="313" text-anchor="middle" font-size="11" fill="#c0392b">flag is false — NOT skipped!</text>

  <!-- Step 6: Observer -> Fabric (redundant update) -->
  <line x1="680" y1="335" x2="130" y2="335" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrow-red)"/>
  <text x="405" y="330" text-anchor="middle" font-size="12" fill="#c0392b">existing.set({left, top}) — REDUNDANT</text>

  <!-- Step 7: Fabric fires again -->
  <line x1="120" y1="365" x2="380" y2="365" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrow-red)"/>
  <text x="250" y="360" text-anchor="middle" font-size="12" fill="#c0392b">object:moving fires AGAIN</text>

  <!-- Loop indicator -->
  <rect x="30" y="390" width="760" height="32" rx="6" fill="#f9ebea" stroke="#e74c3c" stroke-width="2"/>
  <text x="410" y="411" text-anchor="middle" font-size="14" font-weight="bold" fill="#c0392b">FEEDBACK LOOP — object vibrates / ping-pongs</text>

  <!-- ============ AFTER (bottom half) ============ -->
  <text x="410" y="475" text-anchor="middle" font-size="16" font-weight="bold" fill="#27ae60">AFTER (boolean + per-object Set) — loop prevented</text>

  <!-- Fabric box -->
  <rect x="40" y="495" width="160" height="44" rx="6" fill="#a8e6cf" stroke="#333" stroke-width="2"/>
  <text x="120" y="523" text-anchor="middle" font-size="15" font-weight="bold" fill="#333">Fabric.js</text>

  <!-- Yjs box -->
  <rect x="310" y="495" width="160" height="44" rx="6" fill="#ffd3b6" stroke="#333" stroke-width="2"/>
  <text x="390" y="523" text-anchor="middle" font-size="15" font-weight="bold" fill="#333">Yjs Y.Map</text>

  <!-- Observer box -->
  <rect x="590" y="495" width="180" height="44" rx="6" fill="#fdfd96" stroke="#333" stroke-width="2"/>
  <text x="680" y="523" text-anchor="middle" font-size="15" font-weight="bold" fill="#333">Yjs Observer</text>

  <!-- Lifelines -->
  <line x1="120" y1="539" x2="120" y2="870" stroke="#999" stroke-width="1.5" stroke-dasharray="6,4"/>
  <line x1="390" y1="539" x2="390" y2="870" stroke="#999" stroke-width="1.5" stroke-dasharray="6,4"/>
  <line x1="680" y1="539" x2="680" y2="870" stroke="#999" stroke-width="1.5" stroke-dasharray="6,4"/>

  <!-- Step 1: add to Set -->
  <rect x="10" y="555" width="220" height="24" rx="4" fill="#d5f5e3"/>
  <text x="120" y="572" text-anchor="middle" font-size="11" fill="#1a7a3a">localUpdateIds.add("rect-abc")</text>

  <!-- Step 2: flag=true -->
  <rect x="10" y="585" width="220" height="24" rx="4" fill="#d5f5e3"/>
  <text x="120" y="602" text-anchor="middle" font-size="11" fill="#1a7a3a">isLocalUpdateRef = true</text>

  <!-- Step 3: Fabric -> Yjs write -->
  <line x1="120" y1="625" x2="380" y2="625" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="250" y="620" text-anchor="middle" font-size="12" fill="#333">updateObject(rect-abc)</text>

  <!-- Step 4: flag=false -->
  <rect x="10" y="641" width="220" height="24" rx="4" fill="#fdebd0"/>
  <text x="120" y="658" text-anchor="middle" font-size="11" fill="#7d6608">isLocalUpdateRef = false</text>

  <!-- Note: Set still has ID -->
  <rect x="10" y="671" width="220" height="24" rx="4" fill="#d5f5e3"/>
  <text x="120" y="688" text-anchor="middle" font-size="11" fill="#1a7a3a">Set still has "rect-abc"</text>

  <!-- Microtask boundary -->
  <line x1="10" y1="712" x2="790" y2="712" stroke="#f39c12" stroke-width="1" stroke-dasharray="4,3"/>
  <text x="410" y="727" text-anchor="middle" font-size="11" font-style="italic" fill="#e67e22">— microtask boundary (observer deferred) —</text>

  <!-- Step 5: Yjs -> Observer fires LATE -->
  <line x1="390" y1="747" x2="670" y2="747" stroke="#e67e22" stroke-width="2" marker-end="url(#arrow-orange)"/>
  <text x="530" y="742" text-anchor="middle" font-size="12" fill="#333">observer fires (LATE)</text>

  <!-- Step 6: Observer checks Set -->
  <rect x="580" y="760" width="200" height="40" rx="4" fill="#d5f5e3" stroke="#27ae60" stroke-width="1.5"/>
  <text x="680" y="777" text-anchor="middle" font-size="11" fill="#1a7a3a">Set.delete("rect-abc")</text>
  <text x="680" y="793" text-anchor="middle" font-size="11" fill="#1a7a3a">→ returns true → SKIP</text>

  <!-- No arrow back - just an X -->
  <line x1="680" y1="815" x2="130" y2="815" stroke="#bbb" stroke-width="1.5" stroke-dasharray="6,4"/>
  <text x="405" y="810" text-anchor="middle" font-size="12" fill="#999">no redundant update</text>
  <text x="405" y="838" text-anchor="middle" font-size="22" fill="#27ae60">&#10007;</text>

  <!-- Success indicator -->
  <rect x="30" y="855" width="760" height="32" rx="6" fill="#eafaf1" stroke="#27ae60" stroke-width="2"/>
  <text x="410" y="876" text-anchor="middle" font-size="14" font-weight="bold" fill="#27ae60">NO LOOP — Set catches the deferred observer reliably</text>

  <!-- Arrowhead markers -->
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2c3e50"/>
    </marker>
    <marker id="arrow-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#e74c3c"/>
    </marker>
    <marker id="arrow-orange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#e67e22"/>
    </marker>
  </defs>
</svg>